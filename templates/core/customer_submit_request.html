{% extends 'base.html' %}

{% block title %}Submit Service Request{% endblock %}

{% block extra_css %}
<style>
    .pac-container {
        z-index: 10000 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h2>Submit New Service Request</h2>
            <p class="text-muted">Fill out the form below to request service in Melbourne.</p>
            
            <!-- Messages -->
            {% if messages %}
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
            {% endif %}
            
            <div class="card">
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                <strong>Form errors:</strong>
                                {{ form.non_field_errors }}
                            </div>
                        {% endif %}
                        
                        <div class="mb-3">
                            <label for="{{ form.service_type.id_for_label }}" class="form-label">Service Type *</label>
                            {{ form.service_type }}
                            {{ form.service_type.help_text|safe }}
                        </div>
                        
                        <div class="mb-3">
                            <label for="id_address" class="form-label">Service Address (Melbourne) *</label>
                            {{ form.address }}
                            {% if form.address.errors %}
                                <div class="text-danger">{{ form.address.errors }}</div>
                            {% endif %}
                            <small class="form-text text-muted">Start typing your Melbourne address for suggestions</small>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="id_window_start" class="form-label">Earliest Arrival (Date & Time) *</label>
                                {{ form.window_start }}
                                {% if form.window_start.errors %}
                                    <div class="text-danger">{{ form.window_start.errors }}</div>
                                {% endif %}
                                <small class="form-text text-muted">When should the technician arrive?</small>
                                <div id="window_start_error" class="text-danger" style="display: none; margin-top: 5px;"></div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="id_window_end" class="form-label">Latest Completion (Date & Time) *</label>
                                {{ form.window_end }}
                                {% if form.window_end.errors %}
                                    <div class="text-danger">{{ form.window_end.errors }}</div>
                                {% endif %}
                                <small class="form-text text-muted">When should the job be finished by?</small>
                                <div id="window_end_error" class="text-danger" style="display: none; margin-top: 5px;"></div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="id_service_minutes" class="form-label">Estimated Service Duration (minutes) *</label>
                            {{ form.service_minutes }}
                            {% if form.service_minutes.errors %}
                                <div class="text-danger">{{ form.service_minutes.errors }}</div>
                            {% endif %}
                            <small class="form-text text-muted">How long will the service take?</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="id_required_skills" class="form-label">Required Skills *</label>
                            {{ form.required_skills }}
                            {% if form.required_skills.errors %}
                                <div class="text-danger">{{ form.required_skills.errors }}</div>
                            {% endif %}
                            <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple skills</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="id_priority" class="form-label">Priority *</label>
                            {{ form.priority }}
                            {% if form.priority.errors %}
                                <div class="text-danger">{{ form.priority.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="id_notes" class="form-label">Additional Notes</label>
                            {{ form.notes }}
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Submit Request</button>
                            <a href="{% url 'core:customer_dashboard' %}" class="btn btn-secondary">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function initAutocomplete() {
    console.log('Google Maps loaded, initializing autocomplete...');
    
    // Try to find address input by ID
    let addressInput = document.getElementById('id_address');
    if (!addressInput) {
        // Try alternative ID
        addressInput = document.getElementById('address-input');
    }
    
    if (addressInput) {
        console.log('Found address input:', addressInput.id);
        
        const autocomplete = new google.maps.places.Autocomplete(addressInput, {
            types: ['address'],
            componentRestrictions: { country: 'au' }, // Restrict to Australia
            fields: ['formatted_address', 'geometry', 'place_id']
        });
        
        console.log('Autocomplete created successfully');
        
        autocomplete.addListener('place_changed', function() {
            const place = autocomplete.getPlace();
            console.log('Place selected:', place);
            
            if (!place.geometry) {
                console.log("No details available for the selected place");
                return;
            }
            
            // The address is automatically filled in by autocomplete
            console.log('Address selected:', place.formatted_address);
            if (place.geometry && place.geometry.location) {
                console.log('Coordinates:', place.geometry.location.lat(), place.geometry.location.lng());
            }
        });
    } else {
        console.error('Address input field not found! Tried: id_address and address-input');
    }
}

// Validate time windows
function validateTimeWindow() {
    const windowStartInput = document.getElementById('id_window_start');
    const windowEndInput = document.getElementById('id_window_end');
    const startError = document.getElementById('window_start_error');
    const endError = document.getElementById('window_end_error');
    
    if (!windowStartInput || !windowEndInput) {
        return true; // If inputs don't exist, validation passes
    }
    
    const startValue = windowStartInput.value;
    const endValue = windowEndInput.value;
    
    // Clear previous errors
    startError.style.display = 'none';
    startError.textContent = '';
    endError.style.display = 'none';
    endError.textContent = '';
    
    if (!startValue || !endValue) {
        return true; // Let required field validation handle empty values
    }
    
    const startDate = new Date(startValue);
    const endDate = new Date(endValue);
    
    if (startDate >= endDate) {
        const errorMsg = '⚠️ Window start time must be before window end time';
        startError.textContent = errorMsg;
        startError.style.display = 'block';
        endError.textContent = errorMsg;
        endError.style.display = 'block';
        windowStartInput.setCustomValidity(errorMsg);
        windowEndInput.setCustomValidity(errorMsg);
        return false;
    } else {
        windowStartInput.setCustomValidity('');
        windowEndInput.setCustomValidity('');
        return true;
    }
}

// Add event listeners for time window validation
document.addEventListener('DOMContentLoaded', function() {
    const windowStartInput = document.getElementById('id_window_start');
    const windowEndInput = document.getElementById('id_window_end');
    const form = windowStartInput ? windowStartInput.closest('form') : null;
    
    if (windowStartInput) {
        windowStartInput.addEventListener('change', validateTimeWindow);
        windowStartInput.addEventListener('input', validateTimeWindow);
    }
    
    if (windowEndInput) {
        windowEndInput.addEventListener('change', validateTimeWindow);
        windowEndInput.addEventListener('input', validateTimeWindow);
    }
    
    // Validate on form submission
    if (form) {
        form.addEventListener('submit', function(e) {
            if (!validateTimeWindow()) {
                e.preventDefault();
                e.stopPropagation();
                // Focus on the first invalid field
                if (windowStartInput) {
                    windowStartInput.focus();
                }
                return false;
            }
        });
    }
});

// Load Google Maps script with callback
window.addEventListener('load', function() {
    const script = document.createElement('script');
    script.src = 'https://maps.googleapis.com/maps/api/js?key={{ api_key }}&libraries=places&callback=initAutocomplete';
    script.async = true;
    script.defer = true;
    document.body.appendChild(script);
});
</script>
{% endblock %}

